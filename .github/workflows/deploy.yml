name: Auto-Deploy Website

on:
  push:
    branches: [ main ]
  release:
    types: [ published ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'adopt'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build with Maven
      run: mvn clean package -DskipTests
      
    - name: Get build info
      id: build-info
      run: |
        echo "version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)" >> $GITHUB_OUTPUT
        echo "size=$(ls -lh target/*.jar | awk '{print $5}')" >> $GITHUB_OUTPUT
        echo "build-time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        
    - name: Update build status JSON
      run: |
        cat > api/build-status.json << EOF
        {
          "version": "${{ steps.build-info.outputs.version }}",
          "size": "${{ steps.build-info.outputs.size }}",
          "buildTime": "${{ steps.build-info.outputs.build-time }}",
          "status": "SUCCESS",
          "downloadUrl": "./releases/SolarCrate-latest.jar",
          "changelog": [
            {
              "date": "$(date '+%Y-%m-%d')",
              "version": "${{ steps.build-info.outputs.version }}",
              "changes": [
                "✅ Enhanced Drag/Drop: Linh hoạt hơn nhưng bảo mật",
                "🛡️ Control Protection: Glass panes, buttons không thể lấy",
                "🔒 Original Item Security: Items gốc được bảo vệ",
                "📱 Smart Detection: Phân biệt items an toàn"
              ]
            }
          ],
          "requirements": {
            "minecraft": "1.21.1+",
            "server": "Paper/Spigot/Folia",
            "java": "17+",
            "dependencies": ["PlaceholderAPI (Optional)"]
          },
          "download": {
            "primary": "./releases/SolarCrate-latest.jar",
            "backup": "https://github.com/${{ github.repository }}/releases/latest"
          }
        }
        EOF
        
    - name: Copy JAR to releases
      run: |
        mkdir -p releases
        cp target/*.jar releases/SolarCrate-latest.jar
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        keep_files: true
        
    - name: Create Release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ./releases/SolarCrate-latest.jar
        asset_name: SolarCrate-${{ steps.build-info.outputs.version }}.jar
        asset_content_type: application/java-archive